version: 2
jobs:
  build:
    working_directory: ~/serverless
    docker:
      - image: circleci/node:8.11
    environment:
      TERRAFORM_VERSION: 0.11.7

    steps:
      - checkout

      ## Run checks form functions
      - run:
          name: Installing Packages
          command: |
            cd functions
            yarn install
      - run:
          name: Node Security
          command: make nsp
      - run:
          name: Linting
          command: make lint
      - run:
          name: Unit Tests
          command: make test

      ## Run checks for client application
      - run:
          name: Installing Packages
          command: |
            cd client
            yarn install
      - run:
          name: Unit Tests
          command: make test-client

      ## Run checks form Terraform codes
      - run:
          name: Installing Terraform
          command: |
            curl -Os https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
            sudo unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin
            sudo chmod 755 /usr/local/bin/terraform
      - run:
          name: Configuring Terraform
          command: |
            echo "access_key  = \"$AWS_ACCESS_KEY\"" >  terraform/terraform.tfvars
            echo "secret_key  = \"$AWS_SECRET_KEY\"" >> terraform/terraform.tfvars
            echo "environment = \"ci\""              >> terraform/terraform.tfvars
            echo "region      = \"$AWS_REGION\""     >> terraform/terraform.tfvars
            echo "domain      = \"$DOMAIN_NAME\""    >> terraform/terraform.tfvars
      - run:
          name: Terraform Plan
          command: |
            make init
            make plan

      ## Collect build artifacts
      - store_artifacts:
          path: functions/coverage
          prefix: functions/coverage
      - store_artifacts:
          path: client/coverage
          prefix: client/coverage
